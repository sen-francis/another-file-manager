<!DOCTYPE html>
<html>

<head>
  <style>
    h1 {
      text-align: center;
    }

    h2 {
      text-align: center;
    }

    div {
      text-align: center;
    }
  </style>
  <title>Another File Manager</title>
</head>

<body>
  <div class="startPage" id="startPageID">
    <h1>Welcome to Another File Manager!</h1>
    <h2>Select a Folder to Begin Cleaning</h2>
    <div class="file-dialog">
      <input id="inputID" type="file" webkitdirectory directory multiple>
      <br>
      <button id="nextButtonID" onclick="nextFunction()">Next</button>
    </div>
    <!-- You can also require other files to run in this process -->
    <script type="text/javascript">
      function nextFunction() {
        if (document.getElementById("inputID").value != "") {
          // directory selected
          // set filepath as next page header
          // [PROBLEM] : current path: "d/..." -> expected path: "D:/..."
          var fileName = document.getElementById("inputID").files[0].path;
          var filePath = fileName.substring(0, fileName.lastIndexOf("/"));
          document.getElementById("headerID").innerHTML = "Current Folder: " + filePath;
          // open query page
          document.getElementById("startPageID").style.display = "none";
          document.getElementById("searchQueryID").style.display = "block";
        }
        else {
          //directory not selected
          alert("ERROR! Please select a directory before continuing.");
        }
      }
    </script>
  </div>

  <div class="searchQuery" id="searchQueryID" style="display:none">
    <h2 id="headerID">Current Folder: </h2>
    <h2 id="tmpID">Select Search Criteria</h2>
    <div class="search-criteria">
      <div class="date-created">
        <input type="checkbox" id="createdCheckboxID" name="createdCheckbox" value="createdChecked">
        <label for="createdCheckbox">Date Created</label> <br>
        <label for="createdFromDate">From: </label>
        <input type="date" id="createdFromDateID" name="createdFromDate"> <br>
        <label for="createdToDate">To: </label>
        <input type="date" id="createdToDateID" name="createdToDate">
      </div>
      <div class="date-modified">
        <input type="checkbox" id="modifiedCheckboxID" name="modifiedCheckbox" value="modifiedChecked">
        <label for="modifiedCheckbox">Date Modified</label> <br>
        <label for="modifiedFromDate">From: </label>
        <input type="date" id="modifiedFromDateID" name="modifiedFromDate"> <br>
        <label for="modifiedToDate">To: </label>
        <input type="date" id="modifiedToDateID" name="modifiedToDate">
      </div>
      <script type="text/javascript">
        createdFromDateID.max = new Date().toISOString().split("T")[0];
        createdToDateID.max = new Date().toISOString().split("T")[0];
        modifiedFromDateID.max = new Date().toISOString().split("T")[0];
        modifiedToDateID.max = new Date().toISOString().split("T")[0];
      </script>
      <button id="searchButtonID" onclick="resultsPageLoad()">Search</button>
    </div>
    <script>
        function resultsPageLoad(){
          const backend = require("./build/Release/backend.node");
          var createdFromDate = "NULL";
          var createdToDate = "NULL";
          var modifiedFromDate = "NULL";
          var modifiedToDate = "NULL";
          // Parse dates into MM/DD/YYYY strings
          if(document.getElementById("createdCheckboxID").checked == true){
            //get dates from 
            var tmpCreatedFromDate = new Date(document.getElementById("createdFromDateID").value);
            var tmpCreatedToDate = new Date(document.getElementById("createdToDateID").value);

            //check if both dates selected
            if(tmpCreatedFromDate == "Invalid Date" || tmpCreatedToDate == "Invalid Date"){
              alert("[ERROR] Select both dates in created date range, or deselect checkbox.");
              return;
            }

            //check if date range valid
            if(tmpCreatedFromDate > tmpCreatedToDate){
              alert("[ERROR] Created Date Range Invalid!")
              return;
            }

            //convert dates to MM/DD/YYYY format
            createdFromDate = tmpCreatedFromDate.getMonth()+1 + "/" + (tmpCreatedFromDate.getDate()+1) + "/" + tmpCreatedFromDate.getFullYear();
            if(tmpCreatedFromDate.getMonth()+1<10){
              createdFromDate = "0"+createdFromDate;
            }
            createdToDate = tmpCreatedToDate.getMonth()+1 + "/" + (tmpCreatedToDate.getDate()+1) + "/" + tmpCreatedToDate.getFullYear();
            if(tmpCreatedToDate.getMonth()+1<10){
              createdToDate = "0"+createdToDate;
            }
          }

          if(document.getElementById("modifiedCheckboxID").checked == true){
            //get dates from 
            var tmpModifiedFromDate = new Date(document.getElementById("modifiedFromDateID").value);
            var tmpModifiedToDate = new Date(document.getElementById("modifiedToDateID").value);

            //check if both dates selected
            if(tmpModifiedFromDate == "Invalid Date" || tmpModifiedToDate == "Invalid Date"){
              alert("[ERROR] Select both dates in modified date range, or deselect checkbox.");
              return;
            }

            //check if date range valid
            if(tmpModifiedFromDate > tmpModifiedToDate){
              alert("[ERROR] Modified Date Range Invalid!")
              return;
            }

            //convert dates to MM/DD/YYYY format
            modifiedFromDate = tmpModifiedFromDate.getMonth()+1 + "/" + (tmpModifiedFromDate.getDate()+1) + "/" + tmpModifiedFromDate.getFullYear();
            if(tmpModifiedFromDate.getMonth()+1<10){
              modifiedFromDate = "0"+modifiedFromDate;
            }
            modifiedToDate = tmpModifiedToDate.getMonth()+1 + "/" + (tmpModifiedToDate.getDate()+1) + "/" + tmpModifiedToDate.getFullYear();
            if(tmpModifiedToDate.getMonth()+1<10){
              modifiedToDate = "0"+modifiedToDate;
            }
          }
          var fileName = document.getElementById("inputID").files[0].path;
          var filePath = fileName.substring(0, fileName.lastIndexOf("/"));

          //call c++ function to search for files based on criteria
          var results = backend.search(filePath,createdFromDate,createdToDate,modifiedFromDate,modifiedToDate);
          
          //iterate through files and add them to filesList 
          for(const item of results){
            //Get filesList
            var filesList = document.getElementById('filesListID');

            //Create new list element
            var li = document.createElement('li');//li
            
            //Create checkbox
            var checkbox = document.createElement('input');
                checkbox.type = "checkbox";
            
            //add checkbox to list element
            li.appendChild(checkbox);

            //add file name to list element
            li.appendChild(document.createTextNode(item));

            //add list element to filesList
            filesList.appendChild(li); 
          }

        // Displays next screen
        document.getElementById("searchQueryID").style.display = "none";
        document.getElementById("searchResultsID").style.display = "block";
      }
    </script>
  </div>

  <div class="searchResults" id="searchResultsID" style="display:none">
    <h1>Files Found</h1>
    <div class="files">
      <ul id="filesListID" style="list-style-type:none;"></ul>
      <button onclick="finalPageLoad()">Confirm Deletion</button>
    </div>
    <script>
      function finalPageLoad() {
        const backend = require("./build/Release/backend.node");
        //iterate through checkbox list and add selected ones to finalList then call c++ function to delete
        var filesList = document.getElementById("filesListID").getElementsByTagName("li");
        var filesToDelete = [];
        for(var i = 0; i < filesList.length; i++){
          if(filesList[i].firstChild.checked == true){
            filesToDelete.push(filesList[i].lastChild.textContent);
          }
        }
        if(filesToDelete.length == 0){
          alert("[ERROR] Please select at least one file to delete.")
          return;
        }
        var folderName = backend.deleteFiles(filesToDelete);
        document.getElementById("finalHeader1ID").textContent = "Files can be found in the following directory:\n" + folderName;
        document.getElementById("finalHeader2ID").textContent = "To access the directory, enter the following command in Windows Run:\n"+folderName.substring(0,19);
        document.getElementById("searchResultsID").style.display = "none";
        document.getElementById("finalPageID").style.display = "block";
      }
    </script>
  </div>

  <div class="finalPage" id="finalPageID" style="display:none">
    <h2>Files Deleted Succesfully!</h1>
    <h2 id="finalHeader1ID"></h2>
    <h2 id="finalHeader2ID"></h2>
    <h2>After review, delete the directory. Make sure to delete the directory from the Windows Recycle Bin as well.</h2>
    <div>
      <button onclick="startPageLoad()">Clean New Folder</button>
    </div>
    <script>
      function startPageLoad() {
        //document.getElementById("finalPageID").style.display = "none";
        //document.getElementById("startPageID").style.display = "block";
        const remote = require('electron').remote;
        remote.app.relaunch();
        remote.app.exit(0);
      }
    </script>
  </div>
</body>

</html>